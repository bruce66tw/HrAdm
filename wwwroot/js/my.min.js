function Datatable(selector,url,dtConfig,findJson,fnOk,tbarHtml){this.dt=null;this.findJson=findJson;this.recordsFiltered=-1;this.defaultShowOk=!0;this._keepStart=!1;this._start=0;this._nowShowOk=this.defaultShowOk;this.resetCount=function(){this.recordsFiltered=-1};this.find=function(findJson){this.findJson=findJson;this.resetCount();this.dt.search("").draw(!this._keepStart)};this.reload=function(){this._keepStart=!0;this._nowShowOk=!1;this.find(this.findJson)};this.init=function(selector,url,dtConfig,fnOk,tbarHtml){var config={processing:!1,serverSide:!0,jQueryUI:!1,filter:!1,paginate:!0,lengthChange:!0,info:!0,sorting:[],pagingType:"full_numbers",language:{url:"../locale/"+_fun.locale+"/dataTables.txt"},dom:'l<"toolbar">frtip',initComplete:function(){var filter,api;tbarHtml&&$(this).closest(".dataTables_wrapper").find("div.toolbar").html(tbarHtml);filter=$(selector+"_filter input");filter.length>0&&(filter.unbind(),api=this.api(),filter.bind("keyup",function(e){e.keyCode===13&&(this.resetCount(),api.search(this.value).draw())}))}.bind(this),ajax:{url:url,type:"POST",dataType:"json",data:function(arg){arg.findJson=_json.toStr(this.findJson);arg.recordsFiltered=this.recordsFiltered;this._keepStart&&(arg.start=this._start)}.bind(this),dataSrc:function(result){return this._start=this.dt.page.info().start,this._keepStart=!1,result.ErrorMsg!=null&&result.ErrorMsg!=""?(_tool.msg(result.ErrorMsg),result.recordsFiltered=0,this.recordsFiltered=0,[]):(this.recordsFiltered=result.recordsFiltered,fnOk?fnOk(result):result.data===null||result.data.length===0?(_tool.alert(_BR.FindNone,"R"),[]):(this._nowShowOk&&_tool.alert(_BR.FindOk),this._nowShowOk=this.defaultShowOk,result.data))}.bind(this),error:function(xhr,ajaxOptions,thrownError){_tool.hideWait();_tool.msg("Datatable.js error.");xhr!=null&&(console.log("status"+xhr.status),console.log(thrownError))}}},dt;dtConfig&&(config=_json.copy(dtConfig,config));dt=$(selector);dt.on("preXhr.dt",function(){_tool.showWait()});dt.on("xhr.dt",function(){_tool.hideWait()});this.dt=dt.DataTable(config)};this.init(selector,url,dtConfig,fnOk,tbarHtml)}function EditMany(kid,eformId,tplRowId,rowFilter,sortFid){this.init=function(){this.DataFkeyFid="_fkeyfid";this.kid=kid;this.tplRow=$("#"+tplRowId).html();this.sortFid=sortFid;this.hasRowFilter=!_str.isEmpty(rowFilter);this.rowFilter=rowFilter;var rowObj=$(this.tplRow);_edit.setFidTypeVars(this,rowObj);_edit.setFileVars(this,rowObj);this.hasEform=!_str.isEmpty(eformId);this.hasEform&&(this.eform=$("#"+eformId),this.rowsBox=this.eform.find("tbody"));this.deletedRows=[];this.newIndex=0};this.isNewRow=function(row){return this.isNewKey(row[this.kid])};this.reset=function(rowsBox){rowsBox=this.getRowsBox(rowsBox);rowsBox!=null&&rowsBox.empty();this.newIndex=0;this.deletedRows=[]};this.loadJson=function(json){if(this.hasEform){var rows=json==null||json[_crud.Rows]==null?null:json[_crud.Rows];this.loadRows(this.rowsBox,rows)}else this.fnLoadJson(json)};this.loadRow=function(rowBox,row,index){var form=$(Mustache.render(this.tplRow,{Index:index})),i,obj;for(_form.loadRow(form,row),i=0;i<this.fidTypeLen;i=i+2)fid=this.fidTypes[i],obj=_obj.get(fid,form),obj.data(_edit.DataOld,row[fid]);rowBox.append(form)};this.loadRows=function(rowsBox,rows,reset){var rowLen,i,row,box,j,obj2;if(reset===undefined&&(reset=!0),reset&&this.reset(rowsBox),rowLen=rows==null?0:rows.length,rowLen!==0)for(i=0;i<rowLen;i++){for(row=rows[i],box=$(Mustache.render(this.tplRow,row)),j=0;j<this.fidTypeLen;j=j+2)fid=this.fidTypes[j],obj2=_obj.get(fid,box),_edit.setOld(obj2,row[fid]);_form.loadRow(box,row);box.appendTo(rowsBox)}};this.valid=function(){return this.hasEform?this.eform.valid():this.fnValid==null?!0:this.fnValid()};this.getKey=function(box){return _input.get(this.kid,box)};this.getRow=function(trObj){for(var row={},i=0;i<this.fidTypeLen;i=i+2)fid=this.fidTypes[i],obj=_obj.get(fid,trObj),row[fid]=_input.getByType(obj,this.fidTypes[i+1],trObj);return row};this.checkRowFilter=function(){return this.hasRowFilter?!0:(_log.error("EditMany.js this.rowFilter is empty."),!1)};this.elmToRowBox=function(elm){return this.checkRowFilter()?$(elm).closest(this.rowFilter):null};this.getUpdJsonByCrud=function(upKey){return this.hasEform?this.getUpdJson(upKey,this.rowsBox):this.fnGetUpdJson(upKey)};this.getUpdJson=function(upKey,rowsBox){rowsBox=this.getRowsBox(rowsBox);var json={};return json[_crud.Rows]=this.getUpdRows(upKey,rowsBox),json[_crud.Deletes]=this.getDeletedRows(),json};this.isNewKey=function(key){return key.length<=3};this.getUpdRows=function(upKey,rowsBox){if(this.checkRowFilter()){rowsBox=this.getRowsBox(rowsBox);this.setSort(rowsBox);var rows=[],me=this;return rowsBox.find(me.rowFilter).each(function(idx,item){var tr=$(item),key=_input.get(me.kid,tr),row2,diffRow,diff,fid,ftype,value,obj,j;if(me.isNewKey(key)){row2=me.getRow(tr);row2[me.DataFkeyFid]=upKey;rows.push(row2);return}for(diffRow={},diff=!1,j=0;j<me.fidTypes.length;j=j+2)(ftype=me.fidTypes[j+1],ftype!=="label")&&(fid=me.fidTypes[j],obj=_obj.get(fid,tr),value=_input.getByType(obj,ftype,tr),value!=_edit.getOld(obj)&&(diffRow[fid]=value,diff=!0));diff&&(diffRow[kid]=key,rows.push(diffRow))}),rows.length===0?null:rows}};this.getDeletedRows=function(){return this.deletedRows.length===0?null:this.deletedRows.join()};this.onAddRow=function(){this.addRow()};this.addRow=function(rowsBox,row){row=row||{};rowsBox=this.getRowsBox(rowsBox);var obj=this.renderRow(rowsBox,row);return this.boxSetNewId(obj),obj};this.onDeleteRow=function(btn){var box=this.elmToRowBox(btn);this.deleteRow(_itext.get(this.kid,box),box)};this.deleteRow=function(key,rowBox){for(var rows=this.deletedRows,found=!1,rowLen=rows.length,i=0;i<rowLen;i++)if(rows[i][this.kid]===key){found=!0;break}found||(rows[rowLen]=key);_obj.isExist(rowBox)&&rowBox.remove()};this.onViewImage=function(table,fid,elm){var key=this.getKey(this.elmToRowBox(elm));this.isNewKey(key)?_tool.msg(_BR.NewFileNotView):_tool.showImage(elm.innerHTML,_str.format("GetFile?table={0}&fid={1}&key={2}",table,fid,key))};this.renderRow=function(rowsBox,row){rowsBox=this.getRowsBox(rowsBox);var obj=$(Mustache.render(this.tplRow,row));return _form.loadRow(obj,row),obj.appendTo(rowsBox),obj};this.dataAddFiles=function(levelStr,data,rowsBox){if(!this.hasFile||!this.checkRowFilter())return null;rowsBox=this.getRowsBox(rowsBox);var me=this,fileJson={},fileIdx={};return rowsBox.find(me.rowFilter).each(function(index,item){for(var fid,serverFid,tr=$(item),i=0;i<me.fileLen;i++)fid=me.fileFids[i],serverFid=_edit.getServerFid(levelStr,fid),_ifile.dataAddFile(data,fid,serverFid,tr)&&(fileIdx[fid]=fileIdx[fid]==null?0:fileIdx[fid]+1,fileJson[serverFid+fileIdx[fid]]=me.getKey(tr))}),fileJson};this.rowSetFkeyFid=function(row,fkeyFid){row!=null&&this.isNewRow(row)&&(row[this.DataFkeyFid]=fkeyFid)};this.rowsSetFkeyFid=function(rows,fkeyFid){var i,row;if(rows!=null)for(i=0;i<rows.length;i++)row=rows[i],row!=null&&this.isNewRow(row)&&(row[this.DataFkeyFid]=fkeyFid)};this.boxSetNewId=function(box){return this.newIndex++,_itext.set(this.kid,this.newIndex,box),this.newIndex};this.setSort=function(rowsBox){var sortFid=this.sortFid;_str.isEmpty(sortFid)||(rowsBox=this.getRowsBox(rowsBox),rowsBox.find(_fun.getFidFilter(sortFid)).each(function(i,item){_itext.set(sortFid,i,$(item))}))};this.getRowsBox=function(rowsBox){return rowsBox||this.rowsBox};this.init()}function EditOne(kid,eformId){this.init=function(){this.kid=kid||"Id";this.eform=$("#"+(eformId||"eform"));_edit.setFidTypeVars(this,this.eform);_edit.setFileVars(this,this.eform)};this.getKey=function(){return _input.get(this.kid,this.eform)};this.isNewRow=function(){return _str.isEmpty(this.getKey())};this.loadRow=function(row){var i,obj;for(_form.loadRow(this.eform,row),i=0;i<this.fidTypeLen;i=i+2)fid=this.fidTypes[i],obj=_obj.get(fid,this.eform),obj.data(_edit.DataOld,row[fid])};this.getUpdRow=function(){return _edit.getUpdRow(this.kid,this.fidTypes,this.eform)};this.reset=function(){_form.reset(this.eform)};this.setEdit=function(status){_form.setEdit(this.eform,status)};this.dataAddFiles=function(levelStr,data){var fileJson,i,fid,serverFid;if(!this.hasFile)return null;for(fileJson={},i=0;i<this.fileLen;i++)fid=this.fileFids[i],serverFid=_edit.getServerFid(levelStr,fid),_ifile.dataAddFile(data,fid,serverFid,this.eform)&&(fileJson[serverFid]=this.getKey());return fileJson};this.init()}function Flow(boxId,mNode,mLine){this.init=function(){var condOpMaps,j,i,plumb;for(this.StartNode="S",this.EndNode="E",this.NormalNode="N",this.AutoNode="A",this.OrSep="{O}",this.AndSep="{A}",this.ColSep=",",this.NodeFilter=".xf-node",this.MenuFilter=".xf-menu",this.EpFilter=".xf-ep",this.StartNodeCls="xf-start-node",this.EndNodeCls="xf-end-node",this.AutoNodeCls="xf-auto-node",this.InitLineCfg={stroke:"blue",strokeWidth:2},this.OkLineCfg={stroke:"green",strokeWidth:2},this.DenyLineCfg={stroke:"red",strokeWidth:2},this.StartNodeCfg={filter:this.EpFilter,anchor:["Bottom","Left","Right"],connectorStyle:{stroke:"#5c96bc",strokeWidth:2,outlineStroke:"transparent",outlineWidth:3},connectionType:"basic",extract:{action:"the-action"},maxConnections:10},this.EndNodeCfg={dropOptions:{hoverClass:"dragHover"},anchor:["Top","Bottom","Left","Right"],allowLoopback:!0},this.mNode=mNode,this.mLine=mLine,this.divFlowBox=$("#"+boxId),this.divLinesBox=$("#divLinesBox"),this.divLineConds=$("#divLineConds"),this.eformNode=$("#eformNode"),this.eformLine=$("#eformLine"),this.modalNodeProp=$("#modalNodeProp"),this.modalLineProp=$("#modalLineProp"),this.tplNode=$("#tplNode").html(),this.tplLine=$("#tplLine").html(),this.tplLineCond=$("#tplLineCond").html(),this.nowIsNode=!1,this.nowElm=null,condOpMaps=[this.OrSep,") || (",this.AndSep," && ",",eq,","=",",neq,","!=",",gt,",">",",ge,",">=",",st,","<",",se,","<=",],this.condOpExprs=[],this.condOpShows=[],j=0,i=0;i<condOpMaps.length;i=i+2)this.condOpExprs[j]=new RegExp(condOpMaps[i],"g"),this.condOpShows[j]=condOpMaps[i+1],j++;plumb=jsPlumb.getInstance({Container:boxId,Connector:"Flowchart",Endpoint:["Dot",{radius:2}],HoverPaintStyle:{stroke:"#1e8151",strokeWidth:3},ConnectionOverlays:[["Arrow",{location:1,id:"arrow",width:8,length:10,foldback:.8}],["Label",{label:"",id:"label",cssClass:"xf-line-label"}]]});plumb.registerConnectionType("basic",{anchor:"Continuous",connector:"Flowchart"});this.plumb=plumb;this.setFlowEvent()};this.setFlowEvent=function(){var plumb=this.plumb,me=this;plumb.bind("contextmenu",function(elm,event){me.showPopupMenu(elm,event,!1)});plumb.bind("beforeDrop",function(info){var conn=info.connection,prop,row;return plumb.getConnections({source:conn.source,target:conn.target}).length>0?!1:(prop=me.getLineProp(""),conn.setPaintStyle(prop.style),me.setLineLabel(conn,prop.label),row={StartNode:me.elmToNodeValue(conn.source,"Id"),EndNode:me.elmToNodeValue(conn.target,"Id"),CondStr:"",Sort:9},me.setLineKey(conn,me.addLine(row)),!0)});$(document).bind("mousedown",function(e){var filter=me.MenuFilter;!$(e.target).parents(filter).length>0&&$(filter).hide(100)})};this.setNodeEvent=function(nodeObj){var nodeType=_itext.get("NodeType",nodeObj),plumb=this.plumb,me=this,nodeElm=nodeObj[0];plumb.draggable(nodeElm,{grid:[10,10],stop:function(params){var pos=$(params.el).position();_form.loadRow(nodeObj,{PosX:pos.left,PosY:pos.top})}});nodeType!=this.EndNode&&plumb.makeSource(nodeElm,this.StartNodeCfg);nodeType!=this.StartNode&&plumb.makeTarget(nodeElm,this.EndNodeCfg);nodeObj.on("contextmenu",function(event){me.showPopupMenu(event.target,event,!0)})};this.loadNodes=function(json){var box,rows,i,me;for(jsPlumb.setSuspendDrawing(!0),box=this.divFlowBox,box.find(this.NodeFilter).remove(),rows=_crud.getJsonRows(json),i=0;i<rows.length;i++)this.setNodeClass(rows[i]);this.mNode.loadRows(box,rows,!1);me=this;box.find(this.NodeFilter).each(function(){me.setNodeEvent($(this))});jsPlumb.setSuspendDrawing(!1,!0)};this.loadLines=function(json){var conns,rows,i;for(jsPlumb.setSuspendDrawing(!0),conns=this.plumb.getAllConnections(),i=0;i<conns.length;i++)this.plumb.deleteConnection(conns[i]);for(rows=_crud.getJsonRows(json),i=0;i<rows.length;i++)this.renderLine(rows[i]);this.mLine.loadRows(this.divLinesBox,rows);jsPlumb.setSuspendDrawing(!1,!0)};this.setNodeClass=function(row){switch(row.NodeType){case this.StartNode:row._NodeClass=this.StartNodeCls;break;case this.EndNode:row._NodeClass=this.EndNodeCls;break;case this.AutoNode:row._NodeClass=this.AutoNodeCls}return row};this.addNode=function(name,nodeType){var row={Name:name,NodeType:nodeType,PosX:100,PosY:100},node=this.mNode.addRow(this.divFlowBox,this.setNodeClass(row));this.setNodeEvent(node)};this.idToNode=function(id){return this.divFlowBox.find(".xf-node [value="+id+"]").closest(".xf-node")};this.elmToNode=function(elm){return $(elm).closest(this.NodeFilter)};this.elmToNodeValue=function(elm,fid){var node=this.elmToNode(elm);return this.boxGetValue(node,fid)};this.boxGetValue=function(node,fid){return _itext.get(fid,node)};this.boxGetValues=function(node,fids){for(var fid,json={},i=0;i<fids.length;i++)fid=fids[i],json[fid]=_itext.get(fid,node);return json};this.deleteNode=function(nodeElm){var plumb=this.plumb,node;this.deleteLines(plumb.getConnections({source:nodeElm}));this.deleteLines(plumb.getConnections({target:nodeElm}));node=$(nodeElm);this.mNode.deleteRow(this.getObjKey(node));$(nodeElm).remove()};this.renderLine=function(row){var prop=this.getLineProp(row.CondStr),conn=this.plumb.connect({source:this.idToNode(row.StartNode),target:this.idToNode(row.EndNode),paintStyle:prop.style});this.setLineKey(conn,row.Id);this.setLineLabel(conn,prop.label)};this.addLine=function(row){var newLine=$(this.tplLine),key;return _form.loadRow(newLine,row),key=this.mLine.boxSetNewId(newLine),this.divLinesBox.append(newLine),key};this.setLineKey=function(conn,key){var row={};row.Id=key;conn.setParameters(row)};this.isSourceCondMode=function(sourceType){return sourceType==this.StartNode||sourceType==this.AutoNode};this.getLineProp=function(condStr){return{style:this.InitLineCfg,label:this.condStrToLabel(condStr)}};this.getLineElmKey=function(conn){return conn.getParameters().Id};this.getObjKey=function(obj){return _itext.get("Id",obj)};this.setLineLabel=function(conn,label){var obj=conn.getOverlay("label");obj.setVisible(!_str.isEmpty(label));obj.setLabel(label)};this.deleteLineWithMsg=function(conn){_tool.ans("delete this line ?",function(){this.deleteLine(conn)})};this.deleteLine=function(conn){var json=conn.getParameters();this.mLine.deleteRow(json.Id);this.plumb.deleteConnection(conn)};this.deleteLines=function(conns){for(var i=0;i<conns.length;i++)this.deleteLine(conns[i])};this.showPopupMenu=function(elm,event,isNode){event.preventDefault();this.nowIsNode=isNode;this.nowElm=isNode?$(elm).closest(this.NodeFilter)[0]:elm;var canEdit=!0,nodeType;isNode?(nodeType=this.elmToNodeValue(elm,"NodeType"),canEdit=nodeType==this.NormalNode||nodeType==this.AutoNode):(nodeType=this.elmToNodeValue(elm.source,"NodeType"),canEdit=nodeType==this.StartNode||nodeType==this.AutoNode);$(this.MenuFilter).finish().toggle(100).css({top:event.pageY+"px",left:event.pageX+"px"})};this.condStrToLabel=function(str){var hasOr,i;if(_str.isEmpty(str))return"";for(hasOr=str.indexOf(this.OrSep)>0,i=0;i<this.condOpExprs.length;i++)str=str.replace(this.condOpExprs[i],this.condOpShows[i]);return hasOr&&(str="("+str+")"),str};this.condStrToList=function(str){var i,andList,j,cols;if(_str.isEmpty(str))return null;var list=[],k=0,orList=str.split(this.OrSep),orLen=orList.length,hasOr=orLen>1;for(i=0;i<orLen;i++)for(andList=orList[i].split(this.AndSep),j=0;j<andList.length;j++)cols=andList[j].split(this.ColSep),list[k]={AndOr:hasOr?this.OrSep:this.AndSep,Fid:cols[0],Op:cols[1],Value:cols[2]},k++;return list};this.getCondStr=function(){var me=this,condStr="";return this.divLineConds.find("tr").each(function(idx){var tr=$(this),str=(idx==0?"":_iselect.get("AndOr",tr))+_itext.get("Fid",tr)+me.ColSep+_iselect.get("Op",tr)+me.ColSep+_itext.get("Value",tr);condStr+=str}),condStr};this.showModalNode=function(){var node=this.elmToNode(this.nowElm),row=this.boxGetValues(node,["NodeType","Name","SignerType","SignerValue"]);_form.loadRow(this.modalNodeProp,row);_modal.showO(this.modalNodeProp)};this.showModalLine=function(conn){var form=this.eformLine,line=this.connToLine(conn),condList,i,newCond;if(_iread.set("StartNode",this.elmToNodeValue(conn.source,"Name"),form),_iread.set("EndNode",this.elmToNodeValue(conn.target,"Name"),form),_itext.set("Sort",this.boxGetValue(line,"Sort"),form),_modal.showO(this.modalLineProp),this.divLineConds.empty(),condList=this.condStrToList(this.boxGetValue(line,"CondStr")),condList!=null)for(i=0;i<condList.length;i++)newCond=$(this.tplLineCond),_form.loadRow(newCond,condList[i]),this.divLineConds.append(newCond)};this.connToLine=function(conn){return this.idToLine(this.getLineElmKey(conn))};this.idToLine=function(id){return this.divLinesBox.find(".xd-line [value="+id+"]").closest(".xd-line")};this.onAddStartNode=function(){if(this.divFlowBox.find("."+this.StartNodeCls).length>0){_tool.msg("Start Node Already Existed !");return}this.addNode("Start",this.StartNode)};this.onAddEndNode=function(){this.addNode("E",this.EndNode)};this.onAddAutoNode=function(){this.addNode("Auto",this.AutoNode)};this.onAddNormalNode=function(){this.addNode("Node",this.NormalNode)};this.onMenuEdit=function(){this.nowIsNode?this.showModalNode(this.elmToNodeValue(this.nowElm,"NodeType")):this.showModalLine(this.nowElm)};this.onMenuDelete=function(){var me=this;me.nowIsNode?_tool.ans("delete this node ?",function(){me.deleteNode(me.nowElm)}):_tool.ans("delete this line ?",function(){me.deleteLine(me.nowElm)})};this.onAddLineCond=function(){var row={AndOr:this.AndSep,Op:"eq"},cond=$(Mustache.render(this.tplLineCond,row));_form.loadRow(cond,row);this.divLineConds.append(cond)};this.onDeleteLineCond=function(btn){$(btn).closest("tr").remove()};this.onModalNodeOk=function(){_modal.hideO(this.modalNodeProp);var row=_form.toJson(this.eformNode),nodeObj=$(this.nowElm);nodeObj.find(".xd-name").text(row.Name);_itext.set("Name",row.Name,nodeObj);_itext.set("SignerType",row.SignerType,nodeObj);_itext.set("SignerValue",row.SignerValue,nodeObj)};this.onModalLineOk=function(){var prop;_modal.hideO(this.modalLineProp);var condStr=this.getCondStr(),conn=this.nowElm,row={CondStr:condStr,Sort:_itext.get("Sort",this.eformLine)},line=this.connToLine(conn);_form.loadRow(line,row);prop=this.getLineProp(condStr);this.setLineLabel(conn,prop.label);conn.setPaintStyle(prop.style)};this.init()}var _ajax={getJson:function(url,data,fnOk,fnError){var json={url:url,type:"POST",data:data,dataType:"json"};_ajax._call(json,fnOk,fnError)},getJsonByFormData:function(url,data,fnOk,fnError){var json={url:url,type:"POST",cache:!1,data:data,contentType:!1,dataType:"json",processData:!1};_ajax._call(json,fnOk,fnError)},getStr:function(url,data,fnOk,fnError){var json={url:url,type:"POST",data:data,dataType:"text"};_ajax._call(json,fnOk,fnError)},getView:function(url,data,fnOk,fnError){var json={url:url,type:"POST",data:data,dataType:"html"};_ajax._call(json,fnOk,fnError)},getImageFile:function(url,data){var json={url:url,type:"POST",data:data,dataType:"html"};_ajax._call(json)},_call:function(json,fnOk,fnError){var config={success:function(data){data&&data.ErrorMsg?fnError==null?_tool.msg(data.ErrorMsg):fnError(data):fnOk&&fnOk(data)},error:function(xhr,ajaxOptions,thrownError){xhr!=null&&(console.log("status"+xhr.status),console.log(thrownError))},beforeSend:function(){_tool.showWait()},complete:function(){_tool.hideWait()}};$.ajax(_json.copy(json,config))}},_array={find:function(ary,id){if(ary==null)return-1;for(var i=0;i<ary.length;i++)if(ary[i]==id)return i;return-1},toStr:function(ary,sep){return sep=sep||",",ary.join(sep)}},_assert={echo:function(msg){_error.log("_assert.js "+msg)},inArray:function(value,ary){var find=!1;for(var item in ary)if(item==value){find=!0;break}find||_assert.echo("inArray failed: "+value)}},_browser={_langCode:"_langCode",pushState:function(url){history.pushState(null,null,url)},zz_print:function(id,fm,fnCallback){_browser.printO(_obj.getById(id,fm,fnCallback))},zz_printO:function(){window.print()}},_btn={setEdit:function(id,status,box){_btn.setEditO(_obj.getById(id,box),status)},setEditO:function(obj,status){obj.prop("disabled",!status)},setEditF:function(ft,status,box){_btn.setEditO(_obj.getF(ft,box),status)}},_chart={rainbowColors:["#F32E37","#EABE37","#89E926","#22E352","#2FE5E8","#295AE7","#8828EE","#E629B7",],initPie:function(canvasObj,labels,values,colors,config){var config0={type:"pie",options:{legend:{position:"right",labels:{boxWidth:10}}},data:{labels:labels,datasets:[{data:values,backgroundColor:colors,borderWidth:1}]}};return config&&(config0=_json.copy(config,config0)),new Chart(canvasObj,config0)}},_crud={Rows:"_rows",Childs:"_childs",Deletes:"_deletes",temp:{},dtDom:'<"toolbar">t<li>p',dtColConfig:{className:"xg-center",orderable:!1,targets:"_all"},dtCheck0:function(value,editable,fid){return editable===undefined&&(editable=!0),fid=fid||_icheck.check0Id,_icheck.render2(0,fid,value,!1,"",editable)},dtRadio1:function(value,editable){return editable===undefined&&(editable=!0),_iradio.render(_icheck.check0Id,"",!1,value,editable)},dtSetStatus:function(){return""},dtCrudFun:function(key,rowName,hasUpdate,hasDelete,hasView,fnOnUpdate,fnOnDelete,fnOnView){var funs="";return hasUpdate&&(funs+=_str.format('<button type="button" class="btn btn-link" onclick="{0}(\'{1}\')"><i class="ico-pen" title="{2}"><\/i><\/button>',fnOnUpdate==null?"_crud.onUpdate":fnOnUpdate,key,_BR.TipUpdate)),hasDelete&&(funs+=_str.format('<button type="button" class="btn btn-link" onclick="_crud.onDelete(\'{1}\',\'{2}\')"><i class="ico-delete" title="{3}"><\/i><\/button>',fnOnDelete==null?"_crud.onDelete":fnOnDelete,key,rowName,_BR.TipDelete)),hasView&&(funs+=_str.format('<button type="button" class="btn btn-link" onclick="_crud.onView(\'{1}\')"><i class="ico-eye" title="{2}"><\/i><\/button>',fnOnView==null?"_crud.onView":fnOnView,key,_BR.TipView)),funs},init:function(dtConfig,edits){var Childs=_crud.Childs,edit0=null,i;if(edits==null)edit0=new EditOne;else if(edit0=edits[0]===null?new EditOne:edits[0],edits.length>1)for(edit0[Childs]=[],i=1;i<edits.length;i++)edit0[Childs][i-1]=edits[i];_me.nowFun="";_me.divRead=$("#divRead");_me.divEdit=$("#divEdit");_me.rform=$("#rform");_me.rform2=$("#rform2");_me.rform2.length===0&&(_me.rform2=null);_me.edit0=edit0;_me.hasChild=_fun.notNull(_me.edit0[Childs])&&_me.edit0[Childs].length>0;_crud.initForm(_me.edit0);_me.modal=null;_me.dt=new Datatable("#table1","GetPage",dtConfig);_prog.init()},initForm:function(edit){var childLen,i;if(edit.eform!=null)for(_idate.init("",edit.eform),_valid.init(edit.eform),childLen=_crud.getEditChildLen(edit),i=0;i<childLen;i++)_crud.initForm(_crud.getEditChild(edit,i))},getEform0:function(){return _me.edit0.eform},getFindCond:function(){var row=_form.toJson(_me.rform),find2=_me.rform2;return find2!==null&&_obj.isShow(find2)&&_json.copy(_form.toJson(find2),row),row},swap:function(toRead){var oldDiv,newDiv;toRead?(oldDiv=_me.divEdit,newDiv=_me.divRead):(oldDiv=_me.divRead,newDiv=_me.divEdit);_obj.isShow(oldDiv)&&(oldDiv.fadeToggle(200),newDiv.fadeToggle(500));_crud._afterSwap(toRead)},onFind:function(){var cond=_crud.getFindCond();_me.dt.find(cond)},onFind2:function(){var find2=_me.rform2;find2!=null&&(_obj.isShow(find2)?_form.hideShow([find2]):_form.hideShow(null,[find2]))},onExport:function(){var cond=_crud.getFindCond();window.location="Export?cond="+_json.toStr(cond)},onToRead:function(){_crud.toReadMode()},onCreate:function(){var fun=_fun.FunC;_prog.setPath(fun);_crud.setEditStatus(fun);_crud.resetForm(_me.edit0);_crud.swap(!1)},onUpdate:function(key){_crud.getJsonAndSetMode(key,_fun.FunU)},onView:function(key){_crud.getJsonAndSetMode(key,_fun.FunV)},getJsonAndSetMode:function(key,funType){if(_str.isEmpty(key)){_log.error("error: key is empty !");return}_ajax.getJson("GetJson",{key:key},function(data){_prog.setPath(funType);_crud.setEditStatus(funType);_crud.swap(!1);_crud.loadJson(data)})},setEditStatus:function(fun){var isView=fun==_fun.FunV,run=_me.nowFun==_fun.FunV&&!isView?!0:_me.nowFun!=_fun.FunV&&isView?!0:!1,div;_me.nowFun=fun;run&&(div=_me.divEdit,div.find("input, textarea, select, button").prop("disabled",isView),isView&&div.find("#btnToRead").prop("disabled",!1))},onSetStatus:function(me,key){var status=_icheck.checkedO($(me));_ajax.getStr("SetStatus",{key:key,status:status},function(){_tool.alert(_BR.UpdateOk)})},loadJson:function(json){var edit=_me.edit0,childLen,i,edit2;for(edit.loadRow(json),childLen=_crud.getEditChildLen(edit),i=0;i<childLen;i++)edit2=_crud.getEditChild(edit,i),edit2.loadJson(_crud.getChildJson(json,i));_fun.notNull(edit.fnAfterLoadJson)&&edit.fnAfterLoadJson(json)},hasFile:function(){var edit=_me.edit0,childLen,i,edit2;if(edit.hasFile)return!0;for(childLen=_crud.getEditChildLen(edit),i=0;i<childLen;i++)if(edit2=_crud.getEditChild(edit,i),edit2.hasFile)return!0;return!1},getUpdJson:function(formData){var edit0=_me.edit0,row=edit0.getUpdRow(),key=edit0.getKey(),fileJson={},levelStr="0",i,edit2,fileJson2,childJson,data,hasData;edit0.hasFile&&(fileJson=edit0.dataAddFiles(levelStr,formData));var hasChild=!1,childs=[],childLen=_crud.getEditChildLen(edit0);for(i=0;i<childLen;i++)(edit2=_crud.getEditChild(edit0,i),edit2.hasFile&&(fileJson2=edit2.dataAddFiles(levelStr+i,formData,edit2.rowsBox),_json.copy(fileJson2,fileJson)),childJson=edit2.getUpdJsonByCrud(key),childJson!=null)&&(hasChild=!0,childs[i]=childJson);return(data={},hasData=!1,row!=null&&(hasData=!0,data[_crud.Rows]=[row]),hasChild&&(hasData=!0,data[_crud.Childs]=childs),_json.isEmpty(fileJson)||(hasData=!0,data[_edit.FileJson]=fileJson),!hasData)?null:(_crud._removeNull(0,data),data)},getEditChildLen:function(edit){var fid=_crud.Childs;return edit[fid]==null?0:edit[fid].length},getEditChild:function(edit,childIdx){return edit[_crud.Childs][childIdx]},getJsonRows:function(json){return json==null||json[_crud.Rows]==null?null:json[_crud.Rows]},getChildJson:function(upJson,childIdx){var childs=_crud.Childs;return upJson[childs]==null||upJson[childs].length<=childIdx?null:upJson[childs][childIdx]},getChildRows:function(upJson,childIdx){var child=_crud.getChildJson(upJson,childIdx);return _crud.getJsonRows(child)},setChildRows:function(upRow,childIdx,rows){var fid=_crud.Childs,child;return upRow==null&&(upRow={}),upRow[fid]==null&&(upRow[fid]=[]),upRow[fid].length<=childIdx&&(upRow[fid][childIdx]={}),child=upRow[fid][childIdx],child[_crud.Rows]=rows,child},validAll:function(){var edit=_me.edit0,childLen,i,edit2;if(!edit.eform.valid())return!1;for(childLen=_crud.getEditChildLen(edit),i=0;i<childLen;i++)if(edit2=_crud.getEditChild(edit,i),!edit2.valid())return!1;return!0},onSave:function(){var edit0,error;if(!_crud.validAll()){_tool.alert(_BR.InputWrong);return}if(edit0=_me.edit0,_fun.notNull(edit0.fnWhenSave)&&(error=edit0.fnWhenSave(),error!="")){_tool.msg(error);return}var formData=new FormData,row=_crud.getUpdJson(formData),isNew=edit0.isNewRow(),action=isNew?"Create":"Update",data=null;_crud.hasFile()?(data=formData,data.append("json",_json.toStr(row)),isNew||data.append("key",edit0.getKey()),_ajax.getJsonByFormData(action,data,function(result){_crud.afterSave(result)})):(data={json:_json.toStr(row)},isNew||(data.key=edit0.getKey()),_ajax.getJson(action,data,function(result){_crud.afterSave(result)}))},_removeNull:function(level,obj){$.each(obj,function(key,value){var isEmpty,len,i;if(value===null)delete obj[key];else if(_json.isKeyValue(value))_crud._removeNull(level+1,value);else if($.isArray(value)){for($.each(value,function(k,v){_crud._removeNull(level+1,v);_json.isEmpty(v)&&(v=null)}),isEmpty=!0,len=value.length,i=len-1;i>=0;i--)_json.isEmpty(value[i])?isEmpty?delete value[i]:value[i]=null:isEmpty=!1;isEmpty&&delete obj[key]}})},afterSave:function(data){if(_fun.notNull(_me.edit0.fnAfterSave)&&_me.edit0.fnAfterSave(),data.Value==="0"){_tool.msg(_BR.SaveNone);return}_tool.alert(_BR.SaveOk+"("+data.Value+")");_me.dt.reload();_crud.toReadMode()},onCheckAll:function(me,box,fid){_icheck.setF(_fun.getFidFilter(fid)+":not(:disabled)",_icheck.checkedO($(me)),box)},onDelete:function(key,rowName){_crud.temp.data={key:key};_tool.ans(_BR.SureDeleteRow+" ("+rowName+")",function(){_ajax.getStr("Delete",{key:key},function(){_tool.alert(_BR.DeleteOk);_me.dt.reload()})})},onDeleteRows:function(box,dataFid){var keys=_icheck.getCheckedValues(box,dataFid);if(keys.length===0){_tool.msg(_BR.PlsSelectDeleted);return}_crud.temp.data={keys:keys};_tool.ans(_BR.SureDeleteSelected,function(){_ajax.getStr("DeleteByKeys",_crud.temp.data,function(){_tool.alert(_BR.DeleteOk);_me.dt.reload()})})},onOpenModal:function(btn,title,fid){var tr=$(btn).closest("tr");_tool.showArea(title,_itext.get(fid,tr),_crud.isEditMode(),function(result){_itext.set(fid,result,tr)})},resetForm:function(edit){var childLen,i,edit2;for(edit.reset(),childLen=_crud.getEditChildLen(edit),i=0;i<childLen;i++)edit2=_crud.getEditChild(edit,i),edit2.reset()},toReadMode:function(){_prog.resetPath();_crud.swap(!0)},_afterSwap:function(toRead){_me.fnAfterSwap!==undefined&&_me.fnAfterSwap(toRead)},isEditMode:function(){return _me.nowFun!==_fun.FunV}},_date={JsDtFormat:"YYYY-MM-DD HH:mm:ss",getStartEnd:function(){},uiToday:function(){return moment().format(_BR.UiDateFormat)},nowYear:function(){return(new Date).getFullYear()},jsToUiDate:function(ds){return _str.isEmpty(ds)?"":moment(ds,_fun.JsDtFormat).format(_BR.UiDateFormat)},uiToJsDate:function(ds){return _str.isEmpty(ds)?"":moment(ds,_BR.UiDateFormat).format(_fun.JsDtFormat)},jsToUiDt2:function(dts){return _str.isEmpty(dts)?"":moment(dts,_fun.JsDtFormat).format(_BR.UiDtFormat2)},getDt:function(fDate,fTime,box){var date=_idate.get(fDate,box),time=_iselect.get(fTime,box);return date==""?"":time==""?date:date+" "+time},isBig:function(ds1,ds2){return moment(ds1,_fun.JsDtFormat).isAfter(moment(ds2,_fun.JsDtFormat))},getMonthDiff:function(ds1,ds2){return _str.isEmpty(start)||_str.isEmpty(end)?0:_date.getMonthDiffByDate(moment(ds1,_fun.JsDtFormat),moment(ds2,_fun.JsDtFormat))},getMonthDiffByDate:function(dt1,dt2){return(dt2.getFullYear()-dt1.getFullYear())*12+dt2.getMonth()-dt1.getMonth()+1},jsDateAddYear:function(date,year){return moment(date,_fun.JsDtFormat).add(year,"y").format(_fun.JsDtFormat)}},_edit={FileJson:"_fileJson",DataOld:"_old",getOld:function(obj){return obj.data(_edit.DataOld)},setOld:function(obj,value){obj.data(_edit.DataOld,value)},getUpdRow:function(kid,fidTypes,box){var key=_input.get(kid,box),diff,row,fid,ftype,value,obj,j;if(_str.isEmpty(key))return _form.toJson(box);for(diff=!1,row={},j=0;j<fidTypes.length;j=j+2)(ftype=fidTypes[j+1],ftype!=="label")&&(fid=fidTypes[j],obj=_obj.get(fid,box),value=_input.getByType(obj,ftype,box),value!=obj.data(_edit.DataOld)&&(row[fid]=value,diff=!0));return diff?(row[kid]=key,row):null},setFidTypeVars:function(me,box){var fidTypes=[];box.find("[data-fid]").each(function(i,item){var obj=$(item),j=i*2;fidTypes[j]=_obj.getName(obj);fidTypes[j+1]=_input.getType(obj)});me.fidTypes=fidTypes;me.fidTypeLen=me.fidTypes.length},setFileVars:function(me,box){me.fileFids=[];box.find("[data-type=file]").each(function(index,item){me.fileFids[index]=_obj.getName($(item))});me.fileLen=me.fileFids.length;me.hasFile=me.fileFids.length>0},getServerFid:function(levelStr,fid){return"t"+levelStr+"_"+fid},dataSetFileJson:function(data,fileJson){var fid,json;_json.isEmpty(fileJson)||(fid=_edit.FileJson,data.has(fid)&&(json=data.get(fid),fileJson=_json.copy(fileJson,json)),data.set(fid,fileJson))}},_error={log:function(msg){console.log(msg)}},_form={toJson:function(form){var attr="name",array=form.serializeArray(),json={},attr2;return $.each(array,function(){json[this.name]=this.value||""}),form.find(":checkbox").each(function(){var item=$(this),id=item.attr(attr);_fun.notNull(id)&&id.indexOf("-")<0&&(json[id]=_icheck.getO(item))}),attr2="["+attr+"]:radio",form.find(attr2).each(function(){var item=$(this),id=item.attr(attr);json[id]=_iradio.get(id,form)}),json},toJsonStr:function(form){return JSON.stringify(_form.toJson(form))},loadRow:function(form,row){for(var key in row)_input.set(key,row[key],form)},reset:function(form){form.find("[name]").each(function(){_input.setO($(this),"",form)})},hasFile:function(form){return form.find(":file").length>0},getSaveData:function(isNew,key,row,rows,deletes){return{isNew:isNew,key:key,row:_json.toStr(row),rows:_json.toStr(rows),deletes:_form.keysToStr(deletes)}},setEdit:function(form,status){_itext.setEditO(form.find("input:text"),status);_itextarea.setEditO(form.find("textarea"),status);_idate.setEditO(form.find(".xd-date"),status);_iselect.setEditO(form.find("select"),status);_icheck.setEditO(form.find(":checkbox"),status);_iradio.setEditO(form.find(":radio"),status);_btn.setEditO(form.find("button"),status)},hideShow:function(hides,shows){var form1,i,form2;if(hides)for(i=0;i<hides.length;i++)form1=hides[i],form1.fadeOut(500,function(){form1.hide()});if(shows)for(i=0;i<shows.length;i++)form2=shows[i],form2.fadeIn(500,function(){form2.show()})},zz_reset:function(form){form.find("input:text").val("")}},_formData={},_fun={Fid:"fid",JsDateFormat:"YYYY/MM/DD",JsDtFormat:"YYYY/MM/DD HH:mm:ss",XiBorder:"xi-border",XdRequired:"xd-required",errCls:"xg-error",errLabCls:"xg-error-label",FunC:"C",FunR:"R",FunU:"U",FunD:"D",FunV:"V",locale:"zh-TW",maxFileSize:50971520,data:{},isCheck:!0,onHello:function(){_ajax.getStr("../Fun/Hello",null,function(){alert("OK")})},getFidFilter:function(fid){return"[data-fid="+fid+"]"},"default":function(val,val0){return val==null?val0:val},notNull:function(obj){return!(obj==null)},onSetLocale:function(code){_ajax.getStr("../Fun/SetLocale",{code:code},function(){location.reload()})},xgTextBoxValid:function(obj,Regex){var parent=obj.parentNode;Regex==""?obj.value!=""?obj.parentNode.classList.remove("xg-error"):(obj.parentNode.classList.add("xg-error"),_fun.isCheck=!1):obj.value.match(new RegExp(Regex))!=null?obj.parentNode.classList.remove("xg-error"):(obj.parentNode.classList.add("xg-error"),_fun.isCheck=!1)},xgCheckfn:function(){var Inputs,selects,i;for(_fun.isCheck=!0,Inputs=document.getElementsByClassName("xg-textbox"),i=0;i<Inputs.length;i++)Inputs[i].childNodes[1].onchange();for(selects=document.getElementsByClassName("xg-select"),i=0;i<selects.length;i++)selects[i].childNodes[1].value==0||selects[i].childNodes[1].value==""?(selects[i].classList.add("xg-error"),_fun.isCheck=!1):selects[i].classList.remove("xg-error");return _fun.isCheck},zz_onChangeMultiCheck:function(me,fid){var field=$("#"+fid),values="",texts="",separator=field.attr("data-separator"),onClickFn=field.attr("data-onclick");$(field.parent()).find("input:checked").each(function(){values+=$(this).val()+separator;texts+=$(this).text()+","});values!=""&&(values=values.substring(0,values.length-1),texts=texts.substring(0,texts.length-1));field.attr("title",texts);field.val(values);onClickFn!=undefined&&onClickFn!=""&&onClickFn(me,$(me).val())}},_helper={getBaseProp:function(rowNo,fid,value,type,required,editable,extAttr){var attr=_str.format("type='{0}' data-id='{1}' name='{2}' value='{3}'",type,fid,fid+rowNo,value);return required===!0&&(attr+=" required"),editable===!1&&(attr+=" readonly"),_str.isEmpty(extAttr)||(attr+=" "+extAttr),_str.trim(attr)}},_ibase={get:function(fid,box){return _ibase.getO(_obj.get(fid,box))},getF:function(ft,box){return _ibase.getO(_obj.getF(ft,box))},getO:function(obj){return obj.val()},getBorder:function(obj){return obj},set:function(fid,value,box){_ibase.setO(_obj.get(fid,box),value)},setF:function(ft,value,box){_ibase.setO(_obj.getF(ft,box),value)},setO:function(obj,value){obj.val(value)},setEdit:function(fid,status,box){_ibase.setEditO(_obj.get(fid,box),status)},setEditF:function(ft,status,box){_ibase.setEditO(_obj.getF(ft,box),status)},setEditO:function(obj,status){obj.prop("readonly",!status)}},_icheck=$.extend({},_ibase,{check0Id:"_check0",getO:function(obj){return obj.is(":checked")?obj.val():"0"},setO:function(obj,value){var status=value=="1"||value=="True"||value==!0;obj.prop("checked",status)},setEditO:function(obj,status){obj.prop("disabled",!status)},checked:function(fid,box){return _icheck.checkedO(_obj.get(fid,box))},checkedF:function(filter,box){return _icheck.checkedO(_obj.getF(filter,box))},checkedO:function(obj){return obj.is(":checked")},dtCheck0:function(value,checked){_str.isEmpty(value)&&(value=1);var attr="name='"+_icheck.check0Id+"' value='"+value+"'";return checked&&(attr+=" checked"),"<label class='xg-check xg-no-label'>   <input "+attr+" type='checkbox'>   <span><\/span><\/label>"},getCheckedValues:function(box,dataFid){dataFid=dataFid||_icheck.check0Id;var rows=[];return _obj.getF("[name="+dataFid+"]:checked",box).each(function(i){rows[i]=this.value}),rows},setCheckedByJsons:function(box,rows,dataFid){var i,obj;if(!_str.isEmpty(rows))for(dataFid=dataFid||_icheck.check0Id,i=0;i<rows.length;i++)obj=box.find("[value="+rows[i][dataFid]+"]"),_icheck.setO(obj,1)}}),_icolor={init:function(){$(".xg-color").colorpicker({})},get:function(fid,form){return _icolor.getO(_obj.get(fid,form))},getF:function(filter,form){return _icolor.getO(_obj.getF(filter,form))},getO:function(obj){return _icolor.rgbToHex(obj.find("i").css("background-color"))},rgbToHex:function(rgb){var parts=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),i;for(delete parts[0],i=1;i<=3;++i)parts[i]=parseInt(parts[i]).toString(16),parts[i].length==1&&(parts[i]="0"+parts[i]);return"#"+parts.join("")}},_idate=$.extend({},_ibase,{getO:function(obj){return _date.uiToJsDate(obj.val())},setO:function(obj,value){var date=_date.jsToUiDate(value);obj.val(date)},setEditO:function(obj,status){obj.prop("disabled",!status)},init:function(fid,box){var obj=_str.isEmpty(fid)?$(".xg-date"):_obj.get(fid,box).closet(".xg-date");obj.length>0&&_idate.initO(obj)},initO:function(obj){obj.datepicker({language:_fun.locale,autoclose:!0,showOnFocus:!1}).on("changeDate",function(){});obj.find(".input-group-addon").off("click")},initByBox:function(box,fnOnChange){_idate.initO(box.find(".xg-date"),fnOnChange)},toggle:function(btn){$(btn).parent().parent().datepicker("show")},clean:function(btn){$(btn).parent().parent().datepicker("update","")},field3ToDt:function(fDate,fHour,fMin,box){var date=_idate.get(fDate,box),hour,min;return date==""?"":(hour=_iselect.get(fHour,box),min=_iselect.get(fMin,box),date+" "+(hour==""?"00":hour)+":"+(min==""?"00":min))}}),_ifile=$.extend({},_ibase,{getBorder:function(obj){return obj.prev()},setO:function(obj,value){obj.val(value);_ifile._getLink(_ifile.getBorder(obj)).text(value)},dataAddFile:function(data,fid,serverFid,box){var obj=_obj.get(fid,box),file=_ifile._getUploadFile(_ifile.getBorder(obj)),hasFile=file!=null;return hasFile&&data.append(serverFid,file),hasFile},getFileName:function(path){var sep=path.indexOf("/")>0?"/":"\\";return _str.getTail(path,sep)},getFileExt:function(path){return _str.getTail(path,".")},onOpenFile:function(btn){var label=_ifile._getOutBorder(btn),file=_ifile._getFileObj(label);file.focus().trigger("click")},onChangeFile:function(file){var border=_ifile._getOutBorder(file),fileObj=$(file),value=file.value,exts,ext,max;if(_str.isEmpty(value)){_ifile._setValue(border,"");return}if(exts=fileObj.data("exts").toLowerCase(),!_str.isEmpty(exts)&&(ext=_ifile.getFileExt(value).toLowerCase(),exts=","+exts+",",exts.indexOf(","+ext+",")<0)){_tool.msg(_BR.UploadFileNotMatch);file.value="";return}if(max=fileObj.data("max"),file.files[0].size>max*1048576){_tool.msg(_str.format(_BR.UploadFileNotBig,max));file.value="";return}_ifile._setValue(border,value)},onDeleteFile:function(btn){var border=_ifile._getOutBorder(btn);_ifile._setValue(border,"")},zz_init:function(fid,path,form){var fileObj=_obj.get(fid,form);fileObj.val("")},_getOutBorder:function(elm){return $(elm).closest(".xi-border")},_setValue:function(border,value){_ifile._getObj(border).val(value)},_getObj:function(border){return border.next()},_getLink:function(border){return border.find("a")},_getFileObj:function(border){return border.find(":file")},_getUploadFile:function(border){var fileObj=_ifile._getFileObj(border),files=fileObj.get(0).files;return files.length>0?files[0]:null}}),_ihtml={encode:function(value){return $("<div/>").text(value).html()},decode:function(value){return $("<div/>").html(value).text()},encodeRow:function(row,fids){for(var fid,i=0;i<fids.length;i++)fid=fids[i],row[fid]=_ihtml.encode(row[fid]);return row},update:function(fid,box){var filter="#"+fid,obj=box===undefined?$(filter):box.find(filter);obj.summernote("code",obj.text())},updates:function(fids,box){for(var i=0;i<fids.length;i++)_ihtml.update(fids[i],box)}},_input={getObj:function(fid,box){var obj=_obj.get(fid,box);return obj.length==0&&(obj=_obj.getD(fid,box)),obj},get:function(fid,box){var obj=_input.getObj(fid,box);return _input.getO(obj,box)},getO:function(obj){switch(_input.getType(obj)){case"check":return _icheck.getO(obj);case"radio":return _iradio.getO(obj);case"textarea":return _itextarea.getO(obj);case"select":return _iselect.getO(obj);case"file":return _ifile.getO(obj);case"read":return _iread.getO(obj);default:return obj.hasClass("xd-date")?_idate.getO(obj):obj.val()}},set:function(fid,value,box){_input.setO(_input.getObj(fid,box),value,box)},setO:function(obj,value){switch(_input.getType(obj)){case"check":_icheck.setO(obj,value);break;case"radio":value=value||"0";_iradio.setOs(obj,value);break;case"textarea":value=_ihtml.decode(value);obj.html(value);obj.val(value);break;case"select":_iselect.setO(obj,value);break;case"file":_ifile.setO(obj,value);break;case"read":_iread.setO(obj,value);break;default:obj.hasClass("xd-date")?_idate.setO(obj,value):obj.val(value)}},getType:function(obj){return obj.data("type")},getByType:function(obj,type,box){switch(type){case"check":return _icheck.getO(obj);case"radio":return _iradio.getO(obj,box);default:return obj.val()}},getOld:function(obj){return obj.data("old")},isBound:function(filter){var field=$(filter);return field.find(":not(.bound)").length==0},setEdit:function(fid,status,box){_obj.get(fid,box).attr("readonly",!status)},setEdits:function(fids,status,box){for(var i=0;i<fids.length;i++)_obj.get(fids[i],box).attr("readonly",!status)},exist:function(fid,form){return _input.existF("#"+fid,form)},existF:function(filter,form){var field=form===undefined?$(filter):form.find(filter);return field.length>0},_onChangeSelect:function(me){for(var opt,opt2,className="selected",len=me.options.length,i=0;i<len;i++)opt=me.options[i],opt2=$(opt),opt.selected?opt2.hasClass(className)||opt2.addClass(className):opt2.hasClass(className)&&opt2.removeClass(className)},setSelect:function(fid,value){$("#"+fid).selectpicker("val",value)},setValue:function(fid,value){var field=$("#"+fid);field.length==0?console.log("no field: "+fid):field.val(value)},writeMultiValue:function(fid,separator){var value=$("#"+fid+"_tmp").val();value&&(value=value.join(separator));$("#"+fid).val(value)},setLabel:function(fid,value){$("#"+fid).text(value)},showError:function(obj,fid,msg){obj.addClass(_fun.errCls);var filter="[data-id2="+fid+_fun.errTail+"]",parent=obj.parent(),label=parent.find(filter);label.length==0&&(label=parent.next());label.text(msg);label.show()},clearFieldError:function(fid,form){var labelFid="#"+fid+_fun.errTail,error=form===undefined?$(labelFid):form.find(labelFid),field=error.prev(),id=field.attr("id");field.removeClass(_fun.errCls)},clearFieldsError:function(){$("."+_fun.errCls).removeClass(_fun.errCls)}},_iradio=$.extend({},_ibase,{get:function(fid,box){return _iradio.getOs(_obj.get(fid,box))},getO:function(obj){return obj.val()},getOs:function(objs){return objs.filter(":checked").val()},set:function(fid,value,box){_iradio.setOs(_obj.get(fid,box),value)},setO:function(obj){obj.prop("checked",!0)},setOs:function(objs,value){objs.filter("[value="+value+"]").prop("checked",!0)},setEdit:function(fid,status,box){_iradio.setEditOs(_obj.get(fid,box))},setEditOs:function(objs,status){objs.attr("disabled",!status)},render:function(fid,label,checked,value,editable,extClass,extProp){return label=label||"",extClass=extClass||"",extProp=extProp||"",value=value||"",label==""&&(label="&nbsp;"),_str.isEmpty(value)&&(value=1),extProp+=" data-id='"+fid+"' name='"+fid+"' value='"+value+"'",checked&&(extProp+=" checked"),editable===undefined||editable||(extProp+=" disabled"),_str.format("<label class='xg-radio {0}'>   <input type='radio'{1}>{2}   <span><\/span><\/label>",extClass,extProp,label)}}),_iread={get:function(fid,form){return _iread.getO(_obj.get(fid,form))},getF:function(filter,form){return _iread.getO(_obj.getF(filter,form))},getO:function(obj){return obj.text()},set:function(fid,value,form){_iread.setO(_obj.get(fid,form),value)},setF:function(filter,value,form){_iread.setO(_obj.getF(filter,form),value)},setO:function(obj,value){obj.text(value)}},_iselect=$.extend({},_ibase,{getO:function(obj){return obj.length===0?"":obj.find("option:selected").val()},setO:function(obj,value){filter='option[value="'+value+'"]';var item=obj.find(filter);return item.length>0?(item.prop("selected",!0),item):(obj.find("option:selected").prop("selected",!1),null)},setEditO:function(obj,status){obj.prop("disabled",!status)},getIndex:function(fid,box){return _iselect.getIndexO(_obj.get(fid,box))},getIndexO:function(obj){return obj.prop("selectedIndex")},getCount:function(fid,box){return _iselect.getCountO(_obj.get(fid,box))},getCountO:function(obj){return obj.find("option").length},setIndex:function(fid,idx,box){_iselect.setIndexO(_obj.get(fid,box),idx)},setIndexO:function(obj,idx){obj.find("option").eq(idx).prop("selected",!0)},getText:function(fid,box){var obj=_obj.get(fid,box);return _iselect.getTextO(obj)},getTextO:function(obj){return obj.find("option:selected").text()},getData:function(fid,name,box){return _obj.get(fid,box).find("option:selected").data(name)},getDataO:function(obj,name){return obj.find("option:selected").data(name)},setItems:function(fid,items,box){var obj=_obj.get(fid,box);_iselect.setItemsO(obj,items)},setItemsF:function(filter,items,box){var obj=_obj.getF(filter,box);_iselect.setItemsO(obj,items)},setItemsO:function(obj,items){if(obj.find("option").remove(),items!==null)for(var i=0;i<items.length;i++)obj.append($("<option><\/option>").attr("value",items[i].Id).text(items[i].Str))},getExts:function(fid,box){var rows=[];return _obj.get(fid,box).find("option").each(function(i){var me=$(this);rows[i]={Id:me.val(),Str:me.text(),Ext:me.data("ext")}}),rows},setExts:function(fid,items,box){var filter="#"+fid,obj=box?box.find(filter):$(filter),i;if(obj.find("option").remove(),items!=null)for(i=0;i<items.length;i++)obj.append(_str.format("<option data-ext='{0}' value='{1}'>{2}<\/option>",items[i].Ext,items[i].Id,items[i].Str))},valuesToJson:function(json,fids,box){for(var i=0;i<fids.length;i++)json[fids[i]]=_iselect.get(fids[i],box);return json},filterByExt:function(fid,value,rows,box,allItem){var obj,len,i,row;for(allItem===undefined&&(allItem=!1),obj=_obj.get(fid,box),obj.empty(),len=rows.length,i=0;i<len;i++)row=rows[i],(allItem===!0&&row.Ext==""||row.Ext==value)&&obj.append(_str.format('<option value="{0}">{1}<\/option>',row.Id,row.Text));len>0&&_iselect.setIndexO(obj,0)}}),_itext=$.extend({},_ibase,{mask:function(box){_obj.getF("[data-mask!='']",box).each(function(){var me=$(this);me.mask(me.data("mask"))})}}),_itextarea=$.extend({},_ibase,{getO:function(obj){return obj.html()},setO:function(obj,value){obj.html(value)}}),_json={copy:function(from,to){var to=to||{};for(var key in from)to[key]=from[key];return to},keyValuesToJson:function(keyValues,keyId,valueId){var data,i,row;if(keyValues===null||keyValues.length===0)return null;for(keyId||(keyId="Key"),valueId||(valueId="Value"),data={},i=0;i<keyValues.length;i++)row=keyValues[i],data["f"+row[keyId]]=row[valueId];return data},toStr:function(json){return _json.isEmpty(json)?"":JSON.stringify(json)},isEmpty:function(json){return json==null||$.isEmptyObject(json)},isKeyValue:function(value){return Object.prototype.toString.call(value)==="[object Object]"},urlToJson:function(url){url.indexOf("?")>-1&&(url=url.split("?")[1]);var pairs=url.split("&"),json={};return pairs.forEach(function(pair){pair=pair.split("=");pair[0]!==""&&(json[pair[0]]=decodeURIComponent(pair[1]||""))}),json},strToArray:function(str){return $.parseJSON(str)},findIndex:function(rows,fid,value){if(rows==null)return-1;for(var i=0;i<rows.length;i++)if(rows[i][fid]==value)return i;return-1},filterRows:function(rows,fid,value){return rows.filter(function(row){return row[fid]===value})},appendRows:function(froms,tos){var len,i;if(froms!=null&&froms.length!=0)for(len=tos.length,i=0;i<froms.length;i++)tos[len+i]=froms[i]}},_leftmenu={init:function(){_leftmenu.menu=$(".xg-leftmenu");$(".xg-toggle").click(function(e){var me,arrow,clsName;e.preventDefault();me=$(this);me.next().collapse("toggle");arrow=me.find(".xg-arrow");clsName="xg-open";arrow.hasClass(clsName)?arrow.removeClass(clsName):arrow.addClass(clsName)})},onToggleMenu:function(){_leftmenu.menu.toggleClass("xg-close")}},_locale={},_log={_start:0,_now:0,info:function(msg){console.log(msg)},error:function(msg){alert(msg)},logTimeInit:function(name){_start=new Date;_now=_start;name&&console.log(name)},logTime:function(name){var now=new Date,msg=name+":"+(now-_now)+"/"+(now-_start);console.log(msg);_now=new Date}},_modal={show:function(id){$("#"+id).modal("show")},hide:function(id){$("#"+id).modal("hide")},showO:function(obj){obj.modal("show")},hideO:function(obj){obj.modal("hide")},showF:function(filter){$(filter).modal("show")},hideF:function(filter){$(filter).modal("hide")}},_nav={moveLeft:function(obj){obj.insertBefore(obj.prev())},moveRight:function(obj){obj.insertAfter(obj.next())}},_num={isBigZero:function(value,zero){return isNaN(value)?!1:zero||value!=="0"&&value!==0?parseInt(value)<0?!1:!0:!1},isNum:function(value){return!isNaN(value)},toBool:function(value){return value===1},rowToBool:function(row,fids){for(var fid,i=0;i<fids.length;i++)fid=fids[i],row[fid]=_num.toBool(row[fid]);return row},addComma:function(str){str+="";x=str.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";for(var rgx=/(\d+)(\d{3})/;rgx.test(x1);)x1=x1.replace(rgx,"$1,$2");return x1+x2}},_obj={get:function(val,box){return _obj.getF(_fun.getFidFilter(val),box)},getById:function(val,box){return _obj.getF("#"+val,box)},getF:function(ft,box){return box.find(ft)},getN:function(val,box){return _obj.getF("[name="+val+"]",box)},getD:function(val,box){return _obj.getF("[data-id="+val+"]",box)},getV:function(val,box){return _obj.getF("[value="+val+"]",box)},getId:function(obj){return obj.length>0?obj.attr("id"):""},getName:function(obj){return obj.length>0?obj.attr("name"):""},getDid:function(obj){return obj.length>0?obj.data("id"):""},isShow:function(obj){return obj.is(":visible")},isExist:function(obj){return obj!==undefined&&obj!==null&&obj.length>0},hasAttr:function(obj){return obj.attr(attr)}},_pjax={init:function(filter){$(document).pjax("[data-pjax]",filter,{type:"POST"})}},_prog={me:null,oriPath:"",init:function(){_prog.me=$(".xg-prog-path");_prog.oriPath=_prog.me.text()},resetPath:function(){_prog.me.text(_prog.oriPath)},setPath:function(fun){var name=fun==_fun.FunC?_BR.Create:fun==_fun.FunU?_BR.Update:fun==_fun.FunV?_BR.View:"??";_prog.me.text(_prog.oriPath+"-"+name)}},_qrcode={set:function(id,box,url,width){return _qrcode.setO(_obj.getById(id,box),url,width)},setO:function(obj,url,width){return width=width||128,new QRCode(obj[0],{text:url,width:width,height:width,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}},_str={colSep:"@@",isEmpty:function(str){return str===undefined||str===null||str===""},emptyToStr:function(str,newStr){return _str.isEmpty(str)?newStr:str},format:function(){for(var reg,str=arguments[0],i=0;i<arguments.length-1;i++)reg=new RegExp("\\{"+i+"\\}","gm"),str=str.replace(reg,arguments[i+1]);return str},getMid:function(str,find1,find2){var pos,pos2;return _str.isEmpty(str)?"":(pos=str.indexOf(find1),pos<0)?str:(pos2=str.indexOf(find2,pos+1),pos2<0?str.substring(pos+find1.length):str.substring(pos+find1.length,pos2))},getTail:function(value,find){var pos=value.lastIndexOf(find);return pos>0?value.substring(pos+1):value},toBool:function(val){return val=="1"||val==!0||val=="True"},colsToStr:function(){for(var str=arguments[0],i=1;i<arguments.length;i++)str+=_str.colSep+arguments[i];return str},trim:function(str){return $.trim(str)}},_switch={getText:function(yes,no,width,status,inline,fid,cls){var inline2=inline?" xg-inline":"",attr=fid?' id="'+fid+'"':"",html;return status&&(attr+=" checked"),cls=cls?" "+cls:"",html='<label class="switch{5}" style="width:{2}px;"><input{3} class="switch-input{4}" type="checkbox" /><span class="switch-label" data-on="{0}" data-off="{1}"><\/span><span class="switch-handle"><\/span><\/label>',_str.format(html,yes,no,width,attr,cls,inline2)}},_tab={moveLeft:function(obj){obj.insertBefore(obj.prev())},moveRight:function(obj){obj.insertAfter(obj.next())}},_table={rowMoveUp:function(btn){var row=$(btn).closest("tr");row.insertBefore(row.prev())},rowMoveDown:function(btn){var row=$(btn).closest("tr");row.insertAfter(row.next())},rowFun:function(){return""+_str.format('<a href="javascript:_crud.onUpdate(\'{0}\');"><i class="ico-delete" title="{0}"><\/i><\/a>',key,_BR.TipUpdate)+_str.format('<a href="javascript:_table.rowMoveUp(this);"><i class="ico-up" title="{0}"><\/i><\/a>',_BR.TipUpdate)+_str.format('<a href="javascript:_table.rowMoveDown(this);"><i class="ico-down" title="{0}"><\/i><\/a>',_BR.TipUpdate)}},_tool={init:function(){_tool.xgAlert=$("#xgAlert");_tool.xgMsg=$("#xgMsg");_tool.xgAns=$("#xgAns");_tool.xgArea=$("#xgArea");_tool.xgImage=$("#xgImage")},msg:function(msg,fnClose){var box=_tool.xgMsg;box.find(".xd-msg").html(msg);_modal.showO(box);_tool._fnOnMsgClose=fnClose},ans:function(msg,fnYes,fnNo){var box=_tool.xgAns;box.find(".xd-msg").html(msg);_modal.showO(box);_tool._fnOnAnsYes=fnYes;_tool._fnOnAnsNo=fnNo===undefined?null:fnNo},alert:function(msg){var box=_tool.xgAlert;box.find(".xd-msg").text(msg);box.fadeIn(500,function(){box.show();setTimeout(function(){_tool.onAlertClose()},5e3)})},showWait:function(){$("#xgWait").show()},hideWait:function(){$("#xgWait").hide()},showArea:function(title,value,isEdit,fnOk){var box=_tool.xgArea,obj;box.find(".modal-title").text(title);obj=box.find("textarea");obj.val(value);_itextarea.setEditO(obj,isEdit);_btn.setEditO(box.find(".xd-yes"),isEdit);isEdit&&(_tool._fnOnAreaYes=fnOk);_modal.showO(box)},onAreaYes:function(){var box=_tool.xgArea,value;_tool._fnOnAreaYes&&(_modal.hideO(box),value=box.find("textarea").val(),_tool._fnOnAreaYes(value))},showImage:function(fileName,imageSrc){var box=_tool.xgImage;box.find("img").attr("src",imageSrc);box.find("label").text(fileName);_modal.showO(box)},onAlertClose:function(){var box=_tool.xgAlert;box.fadeOut(500,function(){box.hide()})},onAnsYes:function(){_tool._fnOnAnsYes&&(_modal.hideO(_tool.xgAns),_tool._fnOnAnsYes())},onAnsNo:function(){_tool._fnOnAnsNo&&_tool._fnOnAnsNo();_modal.hideO(_tool.xgAns)},onMsgClose:function(){_tool._fnOnMsgClose&&_tool._fnOnMsgClose();_modal.hideO(_tool.xgMsg)}},_valid={init:function(fm,inputConfig){var config={ignore:"",errorElement:"span"};return inputConfig&&(config=_json.copy(inputConfig,config)),fm.validate(config)},getInputBox:function(element){return $(element).closest("."+_fun.XiBorder)},reInit:function(fm,inputConfig){fm.removeData("validator");fm.removeData("unobtrusiveValidation");_valid.init(fm,inputConfig)},anyRegularsWrong:function(fields,msg,expr){var find,i,value;if(fields==null||fields.length==0)return!1;for(find=!1,i=0;i<fields.length;i++)value=$("#"+fields[i]).val(),expr.test(value)||(find=!0,_input.showError(fields[i],msg));return find},anyEmailsWrong:function(fields,msg){return _valid.anyRegularsWrong(fields,msg,/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)},anyAddressesWrong:function(fields,msg){return _valid.anyRegularsWrong(fields,msg,/^\d+\w*\s*(?:(?:[\-\/]?\s*)?\d*(?:\s*\d+\/\s*)?\d+)?\s+/)}},_var={emptyToValue:function(var1,value){return _str.isEmpty(var1)?value:var1},isEmpty:function(var1){return var1===undefined||var1===null}},_xp={temp:{},initApp:function(){_leftmenu.init();_pjax.init(".xu-body");_tool.init();moment.locale(_fun.locale)}};